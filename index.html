<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/index.md at 23-04-2022 16:10
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>cocktails &#x2013; DAW - M7</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-1.9.min.js"></script>
  </head>
  <body class="topBarEnabled">
    <header id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
            <div class="container">
              <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </a>
          <nav class="nav-collapse">
            <ul class="nav">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Info and Reports <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="jacoco/index.html" title="Covertura">Covertura</a></li>
            <li><a href="project-reports.html" title="Reports">Reports</a></li>
            <li><a href="project-info.html" title="Info">Info</a></li>
            <li><a href="apidocs" title="JavaDocs">JavaDocs</a></li>
            <li><a href="https://github.com/ofornes/daw-m7-uf1" title="Source code">Source code</a></li>
            <li><a href="scm.html" title="SCM">SCM</a></li>
            <li><a href="team.html" title="Desenvolupadors">Desenvolupadors</a></li>
        </ul>
      </li>
            </ul>
          </nav>
          <div class="nav-collapse">
          </div>
        </div>
      </div>
    </header>
    <div class="container">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="./" id="bannerLeft"><h2>cocktails</h2>
</a></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 23-04-2022 16:10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.1.4</li>
          </ul>
        </div>
      </header>
        <main id="bodyColumn" >
<h1>DAW - M7</h1>
<p><i>Desenvolupament web en entorn servidor</i></p>
<p><b>Continguts</b></p>
<ol style="list-style-type: decimal">

<li><a href="#Introducci.C3.B3">Introducci&#xf3;</a></li>
<li><a href="#Prova_UF1">Prova UF1</a>
<ol style="list-style-type: decimal">

<li><a href="#Dades">Dades</a></li>
<li><a href="#Autenticaci.C3.B3_i_autoritzaci.C3.B3">Autenticaci&#xf3; i autoritzaci&#xf3;</a></li>
<li><a href="#Controlador">Controlador</a></li>
<li><a href="#Vistes">Vistes</a></li>
</ol>
</li>
<li><a href="#Prova_UF3">Prova UF3</a>
<ol style="list-style-type: decimal">

<li><a href="#Dades_SQL">Dades SQL</a></li>
<li><a href="#Autenticaci.C3.B3_i_autoritzaci.C3.B3">Autenticaci&#xf3; i autoritzaci&#xf3;</a></li>
<li><a href="#Servei_de_Cocktails">Servei de Cocktails</a></li>
</ol>
</li>
</ol><hr /><section>
<h2><a name="Introducci.C3.B3"></a>Introducci&#xf3;</h2>
<p>Per a resoldre les proves UF1 i UF3, s&#x2019;ha creat un projecte Java amb maven.</p>
<p>S&#x2019;ha utilitzat Spring com a framework de desenvolupament per tal d&#x2019;aprofitar els recursos i facilitats que proporciona (IoC, Dependency Injection, etc.)</p>
<p>Per a crear els <i>JavaBeans</i> s'ha utilitzat la llibreria <a class="externalLink" href="https://projectlombok.org/">Lombok</a> que simplifica la implementaci&#xf3; i redueix els errors t&#xed;pics de la farragosa i mec&#xe0;nica feina de implementar <i>getters</i> i <i>setters</i>.</p>
<p>Aquesta utilitat disposa d'un <i>plugin</i> per a diferents IDEs de manera que ofereix els m&#xe8;todes d'acc&#xe9;s a les propietats <i>on the fly</i>.</p>
<p>S&#x2019;ha utilitzat el subm&#xf2;dul Spring MVC per a la part Web.</p>
<p>Tamb&#xe9; s&#x2019;utilitza el subm&#xf2;dul Spring de seguretat per tal de fer el login.</p></section><section>
<h2><a name="Prova_UF1"></a>Prova UF1</h2>
<blockquote>

<p>Fer un sistema de login i un CRUD sense base de dades, totes les variables i maquetaci&#xf3; est&#xe0; adjunta.</p>
</blockquote>
<p>S'ha optat, com ja s'ha esmentat, pel framework Spring MVC.</p>
<p>S'han traslladat els models PHP a models HTML amb el llenguatge de plantilles Thymeleaf.</p>
<p>La classe de configuraci&#xf3; <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html">cat.albirar.daw.cocktails.CocktailsConfiguration</a> &#xe9;s l&#x2019;encarregada de crear els elements <i>injectables</i> de l&#x2019;aplicaci&#xf3;.</p><section>
<h3><a name="Dades"></a>Dades</h3>
<p>Les dades s&#x2019;han despla&#xe7;at de la vista (vars.php) al codi, a un arxiu json (<code>/cocktails/src/main/resources/cocktails.json</code>). Aquest arxiu es carrega a un servei espec&#xed;fic format per una interf&#xed;cie (contracte) i la implementaci&#xf3;.</p>
<ul>

<li>Interf&#xed;cie: <a href="xref/cat/albirar/daw/cocktails/service/ICocktailsService.html">cat.albirar.daw.cocktails.service.ICocktailsService</a></li>
<li>Implementaci&#xf3;: <a href="xref/cat/albirar/daw/cocktails/service/impl/CocktailsServiceImpl.html">cat.albirar.daw.cocktails.service.impl.CocktailsServiceImpl</a></li>
</ul></section><section>
<h3><a name="Autenticaci.C3.B3_i_autoritzaci.C3.B3"></a>Autenticaci&#xf3; i autoritzaci&#xf3;</h3>
<p>L&#x2019;autenticaci&#xf3; i l&#x2019;autoritzaci&#xf3; es fa amb el m&#xf2;dul spring-security. Els usuaris amb les passwords encriptades es creen inicialment per codi i s&#x2019;emmagatzemem en mem&#xf2;ria.</p>
<p>A la classe de configuraci&#xf3;, el m&#xe8;tode <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L54">CocktailsConfiguration.users()</a> s&#x2019;encarrega de crear la infraestructura d&#x2019;autenticaci&#xf3; i assignaci&#xf3; de <i>roles</i>.</p>

<div class="source"><pre class="prettyprint"><code class="language-java">	@Bean
	public UserDetailsService users() {
		// The builder will ensure the passwords are encoded before saving in memory
		UserBuilder userBuilder = User.builder();
		
		UserDetails admin = userBuilder
				.username(&quot;admin&quot;)
				.password(ADMIN_ENC_PASS)
				.roles(&quot;USER&quot;)
				.build();
		UserDetails pepe = userBuilder
				.username(&quot;pepe&quot;)
				.password(PEPE_ENC_PASS)
				.roles(&quot;USER&quot;)
				.build();
		UserDetails manolo = userBuilder
				.username(&quot;manolo&quot;)
				.password(MANOLO_ENC_PASS)
				.roles(&quot;USER&quot;)
				.build();
		return new InMemoryUserDetailsManager(admin, pepe, manolo);
	}
</code></pre></div>
<p>Les constants <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L49">ADMIN_ENC_PASS</a>, <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L50">PEPE_ENC_PASS</a> i <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L51">MANOLO_ENC_PASS</a> contenen les passwords encriptades de <code>vars.php</code>.</p>
<p>La classe <a href="xref/cat/albirar/daw/cocktails/crypt/CocktailsPasswordEncoder.html">cat.albirar.daw.cocktails.crypt.CocktailsPasswordEncoder</a> &#xe9;s l&#x2019;encarregada de codificar les contrasenyes introdu&#xef;des pels usuaris per tal de validar-les amb les dels usuaris registrats.</p>
<p>Implementa el digest <b>SHA-512</b> i concatena el sufix <code>SuperSecret.</code> a les passwords abans de calcular el digest.</p>
<p>S&#x2019;assigna el <i>rol</i> <code>USER</code> a tots els usuaris per tal de definir la pol&#xed;tica d&#x2019;autoritzaci&#xf3;.</p>
<p>Aquesta pol&#xed;tica (paths HTTP i <i>rols</i> que hi poden accedir) es defineix, tamb&#xe9;, a la classe de configuraci&#xf3;, al m&#xe8;tode <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L82">CocktailsConfiguration.web()</a>:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">	@Bean
	public SecurityFilterChain web(HttpSecurity http) throws Exception {
		http
			.authorizeHttpRequests(authorize -&gt; authorize
					.mvcMatchers(&quot;/&quot;).permitAll()
					.mvcMatchers(&quot;/list&quot;, &quot;/show/*&quot;, &quot;/logout&quot;).hasRole(&quot;USER&quot;)
					.anyRequest().denyAll())
			.formLogin(form -&gt; form
					.loginPage(&quot;/&quot;)
					.defaultSuccessUrl(&quot;/&quot;, false)
					.failureUrl(&quot;/&quot;)
					)
			.logout(logout -&gt; logout
		            .logoutRequestMatcher(new AntPathRequestMatcher(&quot;/logout&quot;, &quot;GET&quot;))
		            .clearAuthentication(true)
		            .invalidateHttpSession(true)
		            .logoutSuccessUrl(&quot;/&quot;)
		            )
			;
		return http.build();
	}
</code></pre></div>
<p>L&#x2019;acc&#xe9;s a l&#x2019;arrel (index.html) &#xe9;s perm&#xe8;s a tothom, ja que &#xe9;s la <i>p&#xe0;gina de login</i>. Els paths de <i>list</i> i <i>show</i> estan restringits a usuaris autenticats amb el rol <i>USER</i>, que &#xe9;s el que hem definit com a rol d&#x2019;autoritzaci&#xf3; a la gesti&#xf3; d&#x2019;usuaris.</p>
<p>Es defineix, tamb&#xe9;, la p&#xe0;gina de <i>login</i> i la de <i>logout</i>.</p>
<p>Per &#xfa;ltim, es restringeix l&#x2019;acc&#xe9;s a qualsevol altre <i>path</i>.</p></section><section>
<h3><a name="Controlador"></a>Controlador</h3>
<p>En el patr&#xf3; MVC de l&#x2019;aplicaci&#xf3;, el controlador est&#xe0; implementat per la classe <a href="xref/cat/albirar/daw/cocktails/controllers/MainController.html">cat.albirar.daw.cocktails.controllers.MainController</a>.</p>
<p>Els m&#xe8;todes estan anotats per tal d&#x2019;establir la relaci&#xf3; entre el path i m&#xe8;tode http i el m&#xe8;tode de la classe que ho gestiona, per exemple:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">@GetMapping(&quot;/list&quot;)
public String getList(Model model) {
	model.addAttribute(&quot;cocktails&quot;, cocktailService.findAll());
	return &quot;list&quot;;
}
</code></pre></div>
<p>Les dades provenen del servei que hem esmentat abans i s&#x2019;injecta al controlador amb la interf&#xed;cie:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">@Controller
public class MainController {
	@Autowired
	private ICocktailsService cocktailService;
//...
}
</code></pre></div>
<p>Spring troba la implementaci&#xf3; corresponent per l&#x2019;anotaci&#xf3; de la classe (<code>@Service</code>) i pel fet que implementa la mateixa interf&#xed;cie desitjada en la injecci&#xf3; (veure <a href="xref/cat/albirar/daw/cocktails/service/impl/CocktailsServiceImpl.html">CocktailsServiceImpl</a>).</p></section><section>
<h3><a name="Vistes"></a>Vistes</h3>
<p>Les vistes estan implementades amb el sistema de plantilles <a class="externalLink" href="https://www.thymeleaf.org/">Thymeleaf (https://www.thymeleaf.org/)</a> que t&#xe9; la virtut d&#x2018;integrar-se amb l&#x2019;html de manera que es pot veure pr&#xe0;cticament renderitzat sense necessitat d&#x2019;execuci&#xf3;.</p>
<p>Els models de dades passat a les vistes permet que les plantilles mostrin el contingut.</p>
<p>En el cas de la p&#xe0;gina <i>show</i>, s&#x2019;ha afegit un par&#xe0;metre de path, que consisteix en afegir el codi del cocktail com a segment final del path. Per exemple, per a veure el detall del cocktail amb <i>id</i> 12562, el path &#xe9;s <code>/show/12562</code>. D&#x2019;aquesta manera, les URLs resulten molt m&#xe9;s netes i f&#xe0;cils d&#x2019;indexar pels cercadors.</p></section></section><section>
<h2><a name="Prova_UF3"></a>Prova UF3</h2>
<blockquote>

<p>Fer el mateix que la UF1 amb una base de dades.</p>
</blockquote>
<p>Per a transformar el sistema de la UF1 a un amb base de dades, s&#x2019;han fet els seg&#xfc;ents canvis:</p>
<ol style="list-style-type: decimal">

<li>Afegir una base de dades encastada, en concret <a class="externalLink" href="https://h2database.com/html/main.html">H2</a></li>
<li>Afegir el m&#xf2;dul JDBC de l&#x2019;Spring-Security</li>
<li>S&#x2019;ha creat arxius SQL per a inicialitzar la base de dades:
<ol style="list-style-type: decimal">

<li><code>src/main/resources/db/schema.sql</code> per a crear les taules</li>
<li><code>src/main/resources/db/user_data.sql</code> per a inserir els usuaris, tal i com es feia a la UF1, per&#xf2; en aquest cas a la taula directament</li>
<li><code>src/main/resources/db/cocktails_data.sql</code> per a inserir la informaci&#xf3; dels cocktails. SQL obtingut de transformar el json en SQL</li>
</ol>
</li>
<li>S&#x2019;ha modificat <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html">cat.albirar.daw.cocktails.CocktailsConfiguration</a> per a configurar:
<ol style="list-style-type: decimal">

<li><code>UserDetails</code> basat en JDBC</li>
<li>Afegir els components <code>DataSource</code>, <code>JdbcTemplate</code> i <code>NamedParameterJdbcTemplate</code> per accedir a la base de dades</li>
</ol>
</li>
<li>S&#x2019;ha modificat <a href="xref/cat/albirar/daw/cocktails/service/impl/CocktailsServiceImpl.html">cat.albirar.daw.cocktails.service.impl.CocktailsServiceImpl</a> per a utilitzar la base de dades com a font i no pas llistes o mapes en mem&#xf2;ria.</li>
<li>S&#x2019;han creat un parell de classes per a l&#x2019;operaci&#xf3; amb la base de dades:
<ol style="list-style-type: decimal">

<li><a href="xref/cat/albirar/daw/cocktails/service/db/ConstantsCocktailsDb.html#ConstantsCocktailsDb">cat.albirar.daw.cocktails.service.db.ConstantsCocktailsDb</a></li>
<li><a href="xref/cat/albirar/daw/cocktails/service/mappers/CocktailDetailBeanMapper.html#CocktailDetailBeanMapper">cat.albirar.daw.cocktails.service.mappers.CocktailDetailBeanMapper</a></li>
</ol>
</li>
</ol><section>
<h3><a name="Dades_SQL"></a>Dades SQL</h3>
<p>El canvi de dades en mem&#xf2;ria a SQL, implica, a m&#xe9;s d&#x2019;afegir un parell de depend&#xe8;ncies, crear uns quants elements per a aquesta nova infraestructura.</p>
<p>La base de dades utilitzada &#xe9;s <i>encastada</i>. Es crea en moment d&#x2019;execuci&#xf3; i es destrueix en moment d&#x2019;aturada.</p>
<p>S&#x2019;han creat tres elements per a disposar de la BD:</p>
<p>Primer el <code>DataSource</code>, que &#xe9;s la classe central del sistema JDBC d&#x2019;acc&#xe9;s a BD de Java. En el nostre cas, a m&#xe9;s, serveix per a <i>aixecar</i> la base de dades i inicialitzar esquemes i dades. Tot plegat es fa al m&#xe8;tode <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L87">CocktailsConfiguration.dataSource()</a>:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">	@Bean
	public DataSource dataSource() {
		return new EmbeddedDatabaseBuilder()
                .generateUniqueName(true)
                .setType(EmbeddedDatabaseType.H2)
                .setScriptEncoding(&quot;UTF-8&quot;)
                .addScript(&quot;db/schema.sql&quot;)
                .addScripts(&quot;db/user_data.sql&quot;, &quot;db/cocktails_data.sql&quot;)
                .build();
	}

</code></pre></div>
<p>Amb el DataSource (connexi&#xf3; a la BD), s&#x2019;han creat dos elements m&#xe9;s, per a accedir a l&#x2019;execuci&#xf3; de sent&#xe8;ncies a la base de dades:</p>
<ul>

<li><a class="externalLink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html">JdbcTemplate</a> que permet acc&#xe9;s b&#xe0;sic</li>
<li><a class="externalLink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/namedparam/NamedParameterJdbcTemplate.html">NamedParameterJdbcTemplate</a> que permet acc&#xe9;s amb noms parametritzats a les sent&#xe8;ncies SQL</li>
</ul>
<p>Aquests dos elements, igual que el <code>DataSource</code> s&#xf3;n utilitzats a tot arreu <i>per convenci&#xf3;</i>, de manera que qualsevol element que tingui acc&#xe9;s a base de dades pot indicar la depend&#xe8;ncia (amb <code>@Autowired</code>).</p>
<p>A m&#xe9;s, s&#x2019;han creat tres scripts SQL:</p>
<ul>

<li>

<p><code>src/main/resources/db/schema.sql</code>:</p>

<div class="source"><pre class="prettyprint"><code class="language-SQL">-- Usuaris
CREATE TABLE USERS
(
	USERNAME VARCHAR(50) NOT NULL PRIMARY KEY
	,PASSWORD VARCHAR(500) NOT NULL
	,ENABLED BOOLEAN NOT NULL
);
CREATE TABLE AUTHORITIES
(
	USERNAME VARCHAR(50) NOT NULL
	,AUTHORITY VARCHAR(50) NOT NULL
	,CONSTRAINT FK_AUTHORITIES_USERS FOREIGN KEY(USERNAME) REFERENCES USERS(USERNAME)
);
CREATE UNIQUE INDEX IX_AUTH_USERNAME ON AUTHORITIES (USERNAME,AUTHORITY);
-- Cocktails
CREATE TABLE COCKTAILS
(
	ID_DRINK INTEGER NOT NULL PRIMARY KEY
	,NAME NVARCHAR(200) NOT NULL
	,THUMB VARCHAR(500) NOT NULL
	,INGREDIENTS NVARCHAR(1000) NOT NULL
	,INSTRUCTIONS NVARCHAR(1000) NOT NULL
);
CREATE INDEX IX_NAME ON COCKTAILS (NAME);
</code></pre></div>
<p>L&#x2019;esquema d&#x2019;usuaris s&#x2019;ha obtingut de l&#x2019;arxiu <code>/org/springframework/security/core/userdetails/jdbc/users.ddl</code> del jar <code>spring-security-core-5.6.2.jar</code></p>
</li>
<li>

<p><code>src/main/resources/db/user_data.sql</code> amb les dades d&#x2019;usuaris:</p>

<div class="source"><pre class="prettyprint"><code class="language-SQL">-- Usuaris
INSERT INTO USERS (USERNAME,PASSWORD,ENABLED) VALUES ('admin', '40a12d2b7f546c624461b26bd41573e697e91466dc80ef42acb46685a41b961648422e4529fcbef2fdaf79c7edfbc5e737bed9c224d93ecd26a7f5e028bfa3ed', TRUE);
INSERT INTO USERS (USERNAME,PASSWORD,ENABLED) VALUES ('pepe', 'c63c4194ea7ab967c7a951a2f784d794318de97710e74bd6d3dcfd680058aecc941973c52e0f74e28aca2840db5a61fb64bfbf974037c34dfb94ebe1b4c860aa', TRUE);
INSERT INTO USERS (USERNAME,PASSWORD,ENABLED) VALUES ('manolo', '3acd3650d01ddf7b2c5fd3488997982684da62c9318a54ee239d5a1f3db72e90b548f10489888ba0da2f0384fa161f319b7d707f2f89cdbe1cc1b6d9ed192fd8', TRUE);
-- ROLS
INSERT INTO AUTHORITIES (USERNAME,AUTHORITY) VALUES ('admin', 'ROLE_USER');
INSERT INTO AUTHORITIES (USERNAME,AUTHORITY) VALUES ('pepe', 'ROLE_USER');
INSERT INTO AUTHORITIES (USERNAME,AUTHORITY) VALUES ('manolo', 'ROLE_USER');

</code></pre></div>
<p>La qual cosa &#xe9;s suficient per a l&#x2019;autenticaci&#xf3; i l&#x2019;autoritzaci&#xf3;</p>
</li>
<li>

<p><code>src/main/resources/db/cocktails_data.sql</code> que cont&#xe9; les sent&#xe8;ncies d&#x2019;inserci&#xf3; dels cocktails (obtinguts del json):</p>

<div class="source"><pre class="prettyprint"><code class="language-SQL">-- Cocktails
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12560,'Afterglow','https://www.thecocktaildb.com/images/media/drink/vuquyv1468876052.jpg','1 part Grenadine, 4 parts Orange juice, 4 parts Pineapple juice','Mix. Serve over ice.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12562,'Alice Cocktail','https://www.thecocktaildb.com/images/media/drink/qyqtpv1468876144.jpg','1 cl Grenadine, 1 cl Orange juice, 2 cl Pineapple juice, 4 cl Cream','Shake well, strain into a large cocktail glass.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12862,'Aloha Fruit punch','https://www.thecocktaildb.com/images/media/drink/wsyvrt1468876267.jpg','3/4 cup Water, 2 tsp Ginger, 2 cups Guava juice, 1 1/2 tblsp Lemon juice, 1 1/2 cup Pineapple, 1 cup Sugar, 3-4 cups Pineapple juice','Add 1/4 cup water to ginger root. Boil 3 minutes. Strain. Add the liquid to the guava, lemon and pineapple juices. Make a syrup of sugar and remaining water. Cool. Combine with juices and pineapple. Chill throroughly.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (15106,'Apello','https://www.thecocktaildb.com/images/media/drink/uptxtv1468876415.jpg','4 cl Orange juice, 3 cl Grapefruit juice, 1 cl Apple juice, 1 Maraschino cherry','Stirr. Grnish with maraschino cherry.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12710,'Apple Berry Smoothie','https://www.thecocktaildb.com/images/media/drink/xwqvur1468876473.jpg','1 cup Berries, 2 Apple','Throw everything into a blender and liquify.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12564,'Apple Karate','https://www.thecocktaildb.com/images/media/drink/syusvw1468876634.jpg','2 cups Apple juice, 1 large Carrot','Place all ingredients in the blender jar - cover and whiz on medium speed until well blended. Pour in one tall, 2 medium or 3 small glasses and drink up.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12708,'Banana Cantaloupe Smoothie','https://www.thecocktaildb.com/images/media/drink/uqxqsy1468876703.jpg','Juice of 1/2 Cantaloupe, 1 Banana','Juice cantaloupe, pour juice into blender, add banana, and liquify.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12654,'Banana Milk Shake','https://www.thecocktaildb.com/images/media/drink/rtwwsx1472720307.jpg','10 cl cold Milk, 4 cl Orange juice, 2 tsp Sugar syrup, 1/2 Banana','Blend very well, preferably in a household mixer. Serve in a wine glass, garnish with whipped cream and a piece of banana.');
INSERT INTO COCKTAILS(ID_DRINK,NAME,THUMB,INGREDIENTS,INSTRUCTIONS) VALUES (12656,'Banana Strawberry Shake','https://www.thecocktaildb.com/images/media/drink/vqquwx1472720634.jpg','1/2 lb frozen Strawberries, 1 frozen Banana, 1 cup plain Yoghurt, 1 cup Milk, to taste\n Honey','Blend all together in a blender until smooth.');
-- ... Tallat per a visualitzaci&#xf3; m&#xe9;s c&#xf2;moda
</code></pre></div>
</li>
</ul><section>
<h4><a name="Autenticaci.C3.B3_i_autoritzaci.C3.B3"></a>Autenticaci&#xf3; i autoritzaci&#xf3;</h4>
<p>El m&#xf2;dul <code>spring-security-jdbc</code> proporciona una implementaci&#xf3; d&#x2019;<code>UserDetails</code> que opera amb base de dades.</p>
<p>Requereix dues taules:</p>
<ul>

<li><code>USERS</code> per a enregistrar els usuaris amb les seves passwords codificades i un indicador de si estan actius o no</li>
<li><code>AUTHORITIES</code> per a establir els rols de cada usuari</li>
</ul>
<p>La classe que se n&#x2019;encarrega de llegir, crear, modificar, etc els usuaris &#xe9;s <a class="externalLink" href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/provisioning/JdbcUserDetailsManager.html">JdbcUserDetailsManager</a>. Al jar hi ha un arxiu DDL amb la definici&#xf3; SQL de les taules.</p>
<p>La inicialitzaci&#xf3; &#xe9;s ben senzilla, com es pot veure al m&#xe8;tode <a href="xref/cat/albirar/daw/cocktails/CocktailsConfiguration.html#L55">CockatilsConfiguration.users</a>:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">	@Bean
	public UserDetailsService users(@Autowired DataSource dataSource) {
		return new JdbcUserDetailsManager(dataSource);
	}

</code></pre></div>
<p>El m&#xf2;dul de seguretat que gestiona l&#x2019;acc&#xe9;s a les URLs, t&#xe9; depend&#xe8;ncia amb <code>UserDetailsService</code>, de manera que el canvi de mem&#xf2;ria a SQL no l&#x2019;afecta en absoluta i continua operant perfectament.</p></section><section>
<h4><a name="Servei_de_Cocktails"></a>Servei de Cocktails</h4>
<p>El servei de cocktails: <a href="xref/cat/albirar/daw/cocktails/service/impl/CocktailsServiceImpl.html#L41">cat.albirar.daw.cocktails.service.impl.CocktailsServiceImpl</a> a estat transformat per tal de que utilitzi la base de dades i no pas la mem&#xf2;ria:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">@Service
public class CocktailsServiceImpl implements ICocktailsService {
	@Autowired
	private NamedParameterJdbcTemplate namedParameterJdbcTemplate;
	
	@Autowired
	private RowMapper&lt;CocktailDetailBean&gt; mapper;
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List&lt;CocktailDetailBean&gt; findAll() {
		return namedParameterJdbcTemplate.query(ConstantsCocktailsDb.SQL_FIND_ALL, mapper);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Optional&lt;CocktailDetailBean&gt; findById(String id) {
		List&lt;CocktailDetailBean&gt; l;
		
		l = namedParameterJdbcTemplate.query(ConstantsCocktailsDb.SQL_FIND_BY_ID
				, new MapSqlParameterSource(ConstantsCocktailsDb.ID, Integer.valueOf(id))
				, mapper);
		if(!l.isEmpty()) {
			return Optional.of(l.get(0));
		}
		return Optional.empty();
	}
}
</code></pre></div>
<p>S&#x2019;ha suprimit qualsevol refer&#xe8;ncia als elements de mem&#xf2;ria (arxiu json, llista i mapa), aix&#xed; com el m&#xe8;tode d&#x2019;inicialitzaci&#xf3; que carregava les dades de l&#x2019;arxiu json a mem&#xf2;ria.</p>
<p>Ara s&#x2019;han afegit dues depend&#xe8;ncies d&#x2019;injecci&#xf3;:</p>
<ul>

<li><code>private NamedParameterJdbcTemplate namedParameterJdbcTemplate</code> per a executar sent&#xe8;ncies a la base de dades</li>
<li><code>private RowMapper&lt;CocktailDetailBean&gt; mapper</code> per a delegar la materialitzaci&#xf3; de files de la taula <code>COCKTAILS</code> en inst&#xe0;ncies de la classe <code>CocktailDetailBean</code></li>
</ul>
<p>Els dos m&#xe8;todes del servei s&#x2019;han canviat per tal d&#x2019;obtenir les dades de la taula.</p>
<p>La classe <a href="xref/cat/albirar/daw/cocktails/service/mappers/CocktailDetailBeanMapper.html#CocktailDetailBeanMapper">cat.albirar.daw.cocktails.service.mappers.CocktailDetailBeanMapper</a> &#xe9;s la responsable de convertir les dades dels registres SQL en classes <code>CocktailDetailBean</code>. Aquest sistema forma part del patr&#xf3; JDBC implementat pel framework. La transformaci&#xf3; es fa al m&#xe8;tode <code>mapRow</code>:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">	public CocktailDetailBean mapRow(ResultSet rs, int rowNum) throws SQLException {
		return CocktailDetailBean.builder()
				.id(Integer.toString(rs.getInt(ConstantsCocktailsDb.ID)))
				.name(rs.getString(ConstantsCocktailsDb.NAME))
				.urlThumb(rs.getString(ConstantsCocktailsDb.THUMB))
				.ingredients(rs.getString(ConstantsCocktailsDb.INGREDIENTS))
				.instruccions(rs.getString(ConstantsCocktailsDb.INSTRUCTIONS))
				.build()
				;
	}

</code></pre></div>
<p>Aquest m&#xe8;tode &#xe9;s cridat pel sistema JDBC del framework en obtenir <code>ResultSet</code> d&#x2019;una sent&#xe8;ncia <i>SELECT</i>. El retorn de cada crida s&#x2019;acumula a una llista o b&#xe9; es retorna directament.</p></section></section></section>
        </main>
    </div>
    <hr/>
    <footer>
      <div class="container">
        <div class="row">
            <p>&#169;      2022
</p>
        </div>
        <p id="poweredBy" class="pull-right"><a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
</p>
      </div>
    </footer>
  </body>
</html>